<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>Profil</title>

    <!-- Logo -->
    <link href='https://unpkg.com/boxicons@2.0.7/css/boxicons.min.css' rel='stylesheet'>
</head>
<body>
    <!-- SIDEBAR -->
    <div class="sidebar">
        <!-- titre + logo de la sidebar -->
        <div class="logo-details">
            <i class='bx bxl-c-plus-plus icon'></i>
                <div class="logo_name">pseudo</div>
                <i class='bx bx-menu' id="btn" ></i>
        </div>
        <!-- sidebar list -->
        <ul class="nav-list">
        <li>
            <i class='bx bx-search'></i>
            <input type="text" placeholder="Search...">
            <span class="tooltip">Search</span>
        </li>

        <li>
            <a href="index.html">
              <i class='bx bx-grid-alt'></i>
              <span class="links_name">Home</span>
            </a>
             <span class="tooltip">Home</span>
        </li>
        <!-- profil des users -->
        <li>
            <a href="register.html">
            <i class='bx bx-user'></i>
            <span class="links_name">Profil</span>
        </a>
        <span class="tooltip">Profil</span>
        <!-- messages privés -->
        </li>
        <li>
            <a href="settings.html">
            <i class='bx bx-chat'></i>
            <span class="links_name">Messages</span>
        </a>
        <span class="tooltip">Messages</span>
        </li>
        <!-- paramètre -->
        <li>
            <a href="#">
            <i class='bx bx-cog'></i>
            <span class="links_name">Settings</span>
        </a>
        <span class="tooltip">Settings</span>
        </li>
        <!-- profil -->
        <li class="profile">
            <div class="profile-details">
                <img src="profile.jpg" alt="Profile" class="profile">
                <div class="name_job">
                    <div class="sidebar-name">pseudo</div>
                </div>
            </div>
            <!-- déconnexion compte -->
            <i class='bx bx-log-out' id="log_out"></i>
        </li>
        </ul>
    </div>
<!-- TITRE -->
<section class="home-section">
    <div class="text">Social Working Club</div>


<div class="settings-container" >
    <h2>User Settings</h2>
    <form id="settings-form" enctype="multipart/form-data">
        <label for="username">Change Username:</label>
        <input type="text" id="username" name="username" placeholder="Enter new username">

        <label for="bio">Edit Bio:</label>
        <textarea id="bio" name="bio" placeholder="Edit your bio"></textarea>

        <label for="profile-pic">Change Profile Picture:</label>
        <input type="file" id="profile-pic" name="profile-pic">

        <div class="settings-option">
            <button type="button" id="manage-posts">Manage Posts</button>
        </div>

        <div class="settings-option">
            <label class="switch">
              <input type="checkbox" id="notifications" name="notifications" checked>
              <span class="slider round"></span>
            </label>
            <span>Notifications</span>
        </div>        

        <div class="settings-option">
            <button type="button" id="logout">Logout</button>
        </div>

        <div class="settings-option">
            <button type="button" id="delete-account">Delete Account</button>
        </div>

        <button type="submit" class="save-changes-btn">Save Changes</button>
    </form>
</div>
</section>


<style>
    .settings-container {
        max-width: 600px;
        margin: 30px auto;
        padding: 20px;
        background-color: #f9f9f9;
        border-radius: 10px;
    }
    
    .settings-container h2 {
        text-align: center;
    }
    
    #settings-form {
        display: flex;
        flex-direction: column;
    }
    
    #settings-form label {
        margin-top: 10px;
    }
    
    #settings-form input[type="text"],
    #settings-form textarea,
    #settings-form input[type="file"] {
        width: 100%;
        padding: 10px;
        margin-top: 5px;
        border-radius: 5px;
        border: 1px solid #ccc;
    }
    
    .settings-option {
        margin-top: 20px;
    }
    
    #settings-form button {
        padding: 10px 15px;
        border-radius: 5px;
        border: none;
        background-color: #007bff;
        color: white;
        cursor: pointer;
    }
    
    #settings-form button:hover {
        background-color: #0056b3;
    }
    
    .save-changes-btn {
        margin-top: 30px;
    }
    
    /* The switch - the box around the slider */
.switch {
    position: relative;
    display: inline-block;
    width: 60px;
    height: 34px;
  }
  
  /* Hide default checkbox */
  .switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }
  
  /* The slider */
  .slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    -webkit-transition: .4s;
    transition: .4s;
  }
  
  .slider:before {
    position: absolute;
    content: "";
    height: 26px;
    width: 26px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    -webkit-transition: .4s;
    transition: .4s;
  }
  
  input:checked + .slider {
    background-color: #2196F3; /* Active state color */
  }
  
  input:focus + .slider {
    box-shadow: 0 0 1px #2196F3;
  }
  
  input:checked + .slider:before {
    -webkit-transform: translateX(26px);
    -ms-transform: translateX(26px);
    transform: translateX(26px);
  }
  
  /* Rounded sliders */
  .slider.round {
    border-radius: 34px;
  }
  
  .slider.round:before {
    border-radius: 50%;
  }
  
</style>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script defer>
    document.addEventListener('DOMContentLoaded', function() {
        let sidebar = document.querySelector(".sidebar");
        let closeBtn = document.querySelector("#btn");
        let searchBtn = document.querySelector(".bx-search");
    
        function menuBtnChange() {
            if (sidebar.classList.contains("open")) {
                closeBtn.classList.replace("bx-menu", "bx-menu-alt-right");
            } else {
                closeBtn.classList.replace("bx-menu-alt-right", "bx-menu");
            }
        }
    
        closeBtn.addEventListener("click", () => {
            sidebar.classList.toggle("open");
            menuBtnChange();
        });
    
        searchBtn.addEventListener("click", () => {
            sidebar.classList.toggle("open");
            menuBtnChange();
        });
    
        function handleResponse(response) {
            if (!response.ok) {
                throw Error('Failed to update profile: ' + response.statusText);
            }
            return response.json();
        }
        
        function handleError(error) {
            console.error('Request Failed:', error);
            alert('Error: ' + error.message);
        }
    
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('settings-form');
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(form);
        
                fetch('/updateProfile', { // Make sure this matches your server route exactly
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => alert('Profile updated successfully!'))
                .catch(error => alert('Failed to update profile: ' + error.message));
            });
        });        
    });    

document.getElementById('manage-posts').addEventListener('click', function() {
    // Logic to redirect to manage posts page
    window.location.href = '/manage-posts-url'; // Replace with the actual URL
});

document.getElementById('logout').addEventListener('click', function() {
    window.location.href = '/logout-url'; // Replace with the actual logout URL
});

document.getElementById('delete-account').addEventListener('click', function() {
    // Logic to delete account
    if (confirm('Are you sure you want to delete your account? This cannot be undone.')) {
        // Send the delete request to your backend
        fetch('your-backend-delete-account-endpoint', {
            method: 'POST'
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            // Handle success, maybe redirect to home or login page
            window.location.href = '/after-delete-url'; // Replace with actual URL
        })
        .catch((error) => {
            // Handle errors
            console.error('Error:', error);
            alert('An error occurred while deleting the account.');
        });
    }
});

// Assuming this script is running on the same domain as your server:
const serverEndpoint = '/update-settings';

$('#settings-form').on('submit', function(e) {
    e.preventDefault();
    var formData = {
        username: $('#username').val(),
        bio: $('#bio').val(),
        notifications: $('#notifications').is(':checked')
    };

    $.ajax({
        url: '/api/users/update-settings',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(formData),
        success: function(response) {
            console.log('Response:', response);
            alert('Settings updated successfully!');
        },
        error: function(jqXHR) {
            console.error('Error:', jqXHR.responseText);
            alert('Failed to save settings. ' + jqXHR.responseText);
        }
    });
});

document.getElementById('notifications').addEventListener('change', function() {
    const notificationsEnabled = this.checked;

    fetch('/update-notification-preference', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ notifications: notificationsEnabled }),
        credentials: 'include'
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Error updating notification preference');
        }
        return response.json();
    })
    .then(data => {
        console.log('Notification preference updated:', data);
        // Additional code to handle the successful update...
    })
    .catch(error => {
        console.error('Error:', error);
    });
});    

function subscribeToNotifications() {
    if ('serviceWorker' in navigator && 'PushManager' in window) {
        navigator.serviceWorker.ready.then(registration => {
            registration.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: urlBase64ToUint8Array('your-public-vapid-key')
            })
            .then(subscription => {
                // Send subscription to backend
            })
            .catch(error => {
                console.error('Unable to subscribe to push', error);
            });
        });
    }
}

function unsubscribeFromNotifications() {
    navigator.serviceWorker.ready.then(registration => {
        registration.pushManager.getSubscription().then(subscription => {
            if (subscription) {
                subscription.unsubscribe().then(successful => {
                    console.log('Unsubscription successful: ', successful);

                    // Optionally, inform the backend about this unsubscription
                    fetch('/update-notification-preference', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ notifications: false }),
                        credentials: 'include' // if your API requires cookies or authentication
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Error updating notification preference on the server');
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Server updated with unsubscription: ', data);
                        // Inform the user with a UI update, if needed
                    })
                    .catch(error => {
                        console.error('Error during unsubscription server update:', error);
                    });
                }).catch(error => {
                    console.error('Unsubscription failed: ', error);
                });
            } else {
                console.log('User not subscribed to push notifications.');
            }
        });
    });
}
</script>
    </body>
</html>